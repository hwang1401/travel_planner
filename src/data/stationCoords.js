/**
 * 역별 위경도 좌표 (주소→역 매핑용)
 * timetable.js의 역명과 동기화 유지
 * 좌표 출처: G空間情報センター·공식 위치·근사치
 */
export const STATION_COORDS = {
  // ═══ 후쿠오카 시영 지하철 (전 역) ═══
  // 공항선 (姪浜→福岡空港)
  메이노하마: [33.5833, 130.325],
  무로미: [33.5811, 130.338],
  후지사키: [33.5794, 130.348],
  니시진: [33.5811, 130.357],
  도진마치: [33.5833, 130.366],
  오호리코엔: [33.5872, 130.378],
  아카사카: [33.5883, 130.394],
  덴진: [33.5889, 130.4017],
  나카스카와바타: [33.5903, 130.4065],
  지온: [33.5892, 130.4145],
  하카타: [33.5904, 130.4208],
  히가시히에: [33.5893, 130.429],
  후쿠오카공항: [33.5854, 130.451],
  // 하코자키선 (中洲川端→貝塚)
  고후쿠초: [33.5912, 130.4118],
  치요켄초구치: [33.5933, 130.418],
  마다시쿠대이마에: [33.5972, 130.424],
  하코자키구마에: [33.6003, 130.430],
  하코자키쿠다이마에: [33.6061, 130.436],
  카이즈카: [33.6117, 130.4417],
  // 나나쿠마선 (橋本→博多)
  하시모토: [33.525, 130.476],
  지로마루: [33.535, 130.468],
  카모: [33.542, 130.461],
  노게: [33.548, 130.453],
  우메바야시: [33.555, 130.445],
  후쿠다이마에: [33.562, 130.437],
  나나쿠마: [33.568, 130.428],
  카나야마: [33.572, 130.422],
  차야마: [33.575, 130.416],
  벳푸나나쿠마: [33.578, 130.410],
  록혼마츠: [33.5753, 130.3842],
  사쿠라자카: [33.579, 130.391],
  야쿠인오오도오리: [33.583, 130.401],
  야쿠인: [33.5839, 130.4042],
  와타나베도오리: [33.587, 130.398],
  덴진남: [33.5833, 130.4067],
  쿠시다진자마에: [33.588, 130.415],

  // ═══ 규슈 그 외 ═══
  구마모토: [32.7893, 130.6912],
  구마모토역전: [32.7893, 130.6912],
  신도초: [32.8038, 130.6982],
  가나야마초: [32.8012, 130.6965],
  아소: [32.9353, 131.0522],
  유후인: [33.1956, 131.2044],
  아소산: [32.8822, 131.0642],
  쿠사센리: [32.8822, 131.0642],
  하우스텐보스: [32.7947, 130.7247],
  벳푸: [33.2793, 131.4977],
  나가사키: [32.7522, 129.8686],
  나가사키역전: [32.7522, 129.8686],
  시안바시: [32.7475, 129.8778],
  오우라: [32.7361, 129.8692],
  가고시마: [31.6014, 130.5631],
  가고시마역전: [31.5967, 130.5569],
  가고시마중앙역전: [31.6014, 130.5631],
  수족관구치: [31.5983, 130.5589],
  텐몬칸: [31.5953, 130.5567],
  사쿠라지마부두: [31.6036, 130.5522],
  쿠루메: [33.3197, 130.5153],
  다자이후: [33.5186, 130.5332],
  나가사키공항: [32.9167, 129.9133],
  사세보: [33.15, 129.733],
  운젠: [32.75, 130.3],
  미야자키: [31.9167, 131.4333],
  미야자키공항: [31.8772, 131.4486],
  가고시마공항: [31.8037, 130.7194],
  오무타: [33.0333, 130.45],
  오이타: [33.2333, 131.6],

  // 간사이
  오사카: [34.7024, 135.4959],
  교토: [34.9858, 135.7581],
  난바: [34.6672, 135.4997],
  우메다: [34.7054, 135.4981],
  신오사카: [34.7337, 135.5007],
  덴덴타운: [34.65, 135.5],
  아라시야마: [35.0094, 135.6725],

  // 간토
  도쿄: [35.6812, 139.7671],
  시나가와: [35.6284, 139.7393],
  시부야: [35.6595, 139.7024],
  신주쿠: [35.6896, 139.6916],

  // 홋카이도
  삿포로: [43.0686, 141.3508],
  신치토세공항: [42.7752, 141.6923],
  오타루: [43.1907, 140.9942],
};

/** haversine 거리(km) */
function haversineKm(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a =
    Math.sin(dLat / 2) ** 2 +
    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) ** 2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}

/**
 * 좌표에서 가장 가까운 역 반환
 * @param {number} lat 위도
 * @param {number} lon 경도
 * @param {number} maxKm 반경 제한(km), 기본 50km
 * @returns {{ station: string, km: number } | null}
 */
export function findNearestStation(lat, lon, maxKm = 50) {
  if (lat == null || lon == null || typeof lat !== 'number' || typeof lon !== 'number') return null;
  let nearest = null;
  let minKm = Infinity;
  for (const [station, coords] of Object.entries(STATION_COORDS)) {
    const km = haversineKm(lat, lon, coords[0], coords[1]);
    if (km < minKm && km <= maxKm) {
      minKm = km;
      nearest = { station, km };
    }
  }
  return nearest;
}
